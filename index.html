import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  onAuthStateChanged,
  signOut,
  signInAnonymously,
  signInWithCustomToken,
} from 'firebase/auth';
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  getDocs,
  Timestamp,
  doc, // <-- Tambahkan
  updateDoc, // <-- Tambahkan
  deleteDoc, // <-- Tambahkan
} from 'firebase/firestore';
import {
  LayoutDashboard,
  Ticket,
  ClipboardPlus,
  Wrench,
  UserCheck,
  Truck,
  CalendarCheck,
  PenTool,
  Coffee,
  MoreHorizontal,
  Menu,
  X,
  LogOut,
  User,
  Loader2,
  Send, // <-- 'Send' akan kita ganti untuk WhatsApp
  Trash2,
  FileDown,
  Search,
  ChevronLeft,
  ChevronRight,
  Pencil, // <-- Tambahkan
  MessageSquare, // <-- Tambahkan untuk WhatsApp
} from 'lucide-react';

// --- Konfigurasi Firebase & ID Aplikasi ---
// Variabel ini akan disediakan oleh lingkungan Canvas
const appId = typeof __app_id !== 'undefined' ? __app_id : 'laporan-ticket';

// --- Fallback Config ---
// Gunakan config yang diberikan pengguna jika __firebase_config tidak tersedia
const USER_PROVIDED_CONFIG = {
  apiKey: "AIzaSyC_imtiUZVavmtW94b0GbIj40teeK5jFwY",
  authDomain: "laporan-ticket.firebaseapp.com",
  projectId: "laporan-ticket",
  storageBucket: "laporan-ticket.firebasestorage.app",
  messagingSenderId: "507199711392",
  appId: "1:507199711392:web:6d0a78039414c94cc5c1c5",
  measurementId: "G-ME2B3T11ZL"
};

// Coba dapatkan config dari environment, jika tidak ada (atau kosong), gunakan config dari pengguna
const firebaseConfigJSON = (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}')
  ? __firebase_config
  : JSON.stringify(USER_PROVIDED_CONFIG);


// --- Daftar Branch ---
const BRANCH_LIST = [
  'Branch Ciracas',
  'Branch Cawang',
  'Branch Duren sawit',
  'Branch Rawamangun',
  'Branch Ujung Menteng',
  'Branch Pondok Kopi',
  'Branch Sunter',
  'Branch Pademangan',
  'Branch Pluit',
  'Branch Kelapa Gading',
  'Branch Tanjung Priok'
];

// --- Konfigurasi Menu ---
// Mendefinisikan struktur menu, ikon, dan field untuk form
const MENU_ITEMS = [
  {
    name: 'Dashboard',
    icon: LayoutDashboard,
    page: 'Dashboard',
    isForm: false,
  },
  {
    name: 'Laporan Ticket',
    icon: Ticket,
    page: 'Laporan Ticket',
    isForm: true,
    collectionName: 'tickets',
    fields: [
      { name: 'namaBranch', label: 'Nama Branch', type: 'select', options: BRANCH_LIST },
      { name: 'nomerTiket', label: 'Nomer Tiket', type: 'text' },
      { name: 'judul', label: 'Judul Ticket', type: 'text' },
      { name: 'namaCustomer', label: 'Nama Customer', type: 'text' }, // <-- Tambahkan
      { name: 'noTelepon', label: 'No. Telepon (WA)', type: 'text' }, // <-- Tambahkan
      { name: 'deskripsi', label: 'Deskripsi Masalah', type: 'textarea' },
      { name: 'status', label: 'Status', type: 'select', options: ['Baru', 'Proses', 'Done'] },
    ],
  },
  {
    name: 'Input Ticket',
    icon: ClipboardPlus,
    page: 'Input Ticket',
    isForm: true,
    collectionName: 'tickets', // Menggunakan koleksi yang sama dengan Laporan
    fields: [
      { name: 'namaBranch', label: 'Nama Branch', type: 'select', options: BRANCH_LIST },
      { name: 'nomerTiket', label: 'Nomer Tiket', type: 'text' },
      { name: 'judul', label: 'Judul Ticket', type: 'text' },
      { name: 'namaCustomer', label: 'Nama Customer', type: 'text' }, // <-- Tambahkan
      { name: 'noTelepon', label: 'No. Telepon (WA)', type: 'text' }, // <-- Tambahkan
      { name: 'deskripsi', label: 'Deskripsi Masalah', type: 'textarea' },
      { name: 'status', label: 'Status', type: 'select', options: ['Baru', 'Proses', 'Done'] },
    ],
  },
  {
    name: 'Maintenance',
    icon: Wrench,
    page: 'Maintenance',
    isForm: true,
    collectionName: 'maintenance',
    fields: [
      { name: 'aset', label: 'Nama Aset/Perangkat', type: 'text' },
      { name: 'jadwal', label: 'Jadwal Maintenance', type: 'date' },
      { name: 'status', label: 'Status', type: 'select', options: ['Terjadwal', 'Selesai', 'Ditunda'] },
      { name: 'catatan', label: 'Catatan', type: 'textarea' },
    ],
  },
  {
    name: 'Konfirm Customer',
    icon: UserCheck,
    page: 'Konfirm Customer',
    isForm: true,
    collectionName: 'konfirmasi',
    fields: [
      { name: 'namaCustomer', label: 'Nama Customer', type: 'text' },
      { name: 'noTelepon', label: 'No. Telepon (WA)', type: 'text' }, // <-- Tambahkan
      { name: 'ticketId', label: 'ID Ticket Terkait', type: 'text' },
      { name: 'feedback', label: 'Feedback Customer', type: 'textarea' },
    ],
  },
  {
    name: 'Kendala Vendor',
    icon: Truck,
    page: 'Kendala Vendor',
    isForm: true,
    collectionName: 'kendalaVendor',
    fields: [
      { name: 'namaVendor', label: 'Nama Vendor', type: 'text' },
      { name: 'masalah', label: 'Deskripsi Masalah', type: 'textarea' },
      { name: 'status', label: 'Status', type: 'select', options: ['Dilaporkan', 'Dalam Penanganan', 'Selesai'] },
    ],
  },
  {
    name: 'Absensi',
    icon: CalendarCheck,
    page: 'Absensi',
    isForm: true,
    collectionName: 'absensi',
    fields: [
      { name: 'status', label: 'Status Kehadiran', type: 'select', options: ['Hadir (WFO)', 'Hadir (WFH)', 'Sakit', 'Izin'] },
      { name: 'catatan', label: 'Catatan (Opsional)', type: 'text' },
    ],
  },
  {
    name: 'Tools',
    icon: PenTool,
    page: 'Tools',
    isForm: true,
    collectionName: 'tools',
    fields: [
      { name: 'namaTools', label: 'Nama Tools', type: 'text' },
      { name: 'fungsi', label: 'Fungsi', type: 'textarea' },
    ],
  },
  {
    name: 'Cuti',
    icon: Coffee,
    page: 'Cuti',
    isForm: true,
    collectionName: 'cuti',
    fields: [
      { name: 'jenisCuti', label: 'Jenis Cuti', type: 'select', options: ['Tahunan', 'Sakit', 'Melahirkan', 'Penting'] },
      { name: 'tanggalMulai', label: 'Tanggal Mulai', type: 'date' },
      { name: 'tanggalSelesai', label: 'Tanggal Selesai', type: 'date' },
      { name: 'alasan', label: 'Alasan', type: 'textarea' },
    ],
  },
  {
    name: 'Optional',
    icon: MoreHorizontal,
    page: 'Optional',
    isForm: true,
    collectionName: 'optional',
    fields: [
      { name: 'judul', label: 'Judul', type: 'text' },
      { name: 'keterangan', label: 'Keterangan', type: 'textarea' },
    ],
  },
];

// --- Helper Functions ---
/**
 * Mendapatkan path koleksi publik di Firestore.
 * @param {string} collectionName Nama koleksi.
 * @returns {string} Path lengkap ke koleksi.
 */
const getPublicDataPath = (collectionName) => {
  return `/artifacts/${appId}/public/data/${collectionName}`;
};

/**
 * Format timestamp Firebase menjadi string yang mudah dibaca.
 * @param {Timestamp} timestamp Objek timestamp Firebase.
 * @returns {string} String tanggal dan waktu.
 */
const formatTimestamp = (timestamp) => {
  if (!timestamp) return 'N/A';
  return new Date(timestamp.seconds * 1000).toLocaleString('id-ID', {
    dateStyle: 'medium',
    timeStyle: 'short',
  });
};

// --- Komponen Halaman ---

/**
 * Komponen Dashboard
 * Menampilkan ringkasan statistik dari berbagai koleksi.
 */
function Dashboard({ db, isAuthReady }) {
  const [stats, setStats] = useState({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!db || !isAuthReady) return;

    const fetchStats = async () => {
      setLoading(true);
      try {
        const collectionsToFetch = MENU_ITEMS
          .filter(item => item.isForm && item.collectionName)
          .map(item => item.collectionName);
        
        const uniqueCollections = [...new Set(collectionsToFetch)];

        const statPromises = uniqueCollections.map(async (collectionName) => {
          const path = getPublicDataPath(collectionName);
          const snapshot = await getDocs(query(collection(db, path)));
          return { [collectionName]: snapshot.size };
        });

        const results = await Promise.all(statPromises);
        const combinedStats = results.reduce((acc, current) => ({ ...acc, ...current }), {});
        setStats(combinedStats);
      } catch (error) {
        console.error("Error fetching stats: ", error);
      } finally {
        setLoading(false);
      }
    };

    fetchStats();
  }, [db, isAuthReady]);

  const StatCard = ({ title, value, icon: Icon }) => (
    <div className="bg-white rounded-xl shadow-lg p-6 flex items-center space-x-4 transition-all hover:shadow-xl">
      <div className="p-3 bg-blue-100 text-blue-600 rounded-full">
        <Icon className="w-6 h-6" />
      </div>
      <div>
        <p className="text-sm font-medium text-gray-500">{title}</p>
        <p className="text-2xl font-bold text-gray-800">{loading ? '...' : value}</p>
      </div>
    </div>
  );

  return (
    <div className="animate-fade-in">
      <h1 className="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {MENU_ITEMS
          .filter(item => item.isForm && item.collectionName)
          .map(item => (
            <StatCard
              key={item.page}
              title={`Total ${item.name}`}
              value={stats[item.collectionName] || 0}
              icon={item.icon}
            />
          ))}
      </div>
    </div>
  );
}

/**
 * Komponen Halaman Entri Data (Formulir & Laporan)
 * Komponen reusable untuk input data dan menampilkan laporan.
 */
function DataEntryPage({ db, user, isAuthReady, pageConfig }) {
  const { title, collectionName, fields } = pageConfig;
  const [formData, setFormData] = useState(() =>
    fields.reduce((acc, field) => ({ ...acc, [field.name]: '' }), {})
  );
  const [reportData, setReportData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState('');
  const [searchTerm, setSearchTerm] = useState('');
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const [entriesPerPage, setEntriesPerPage] = useState(10); // Default 10 entri
  const [editingItem, setEditingItem] = useState(null); // <-- State untuk mode edit

  // Listener real-time untuk data laporan
  useEffect(() => {
    if (!db || !isAuthReady || !collectionName) return;

    setLoading(true);
    const path = getPublicDataPath(collectionName);
    const q = query(collection(db, path));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Urutkan berdasarkan createdAt jika ada, dari terbaru
      data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      setReportData(data);
      setLoading(false);
    }, (err) => {
      console.error("Error listening to collection: ", err);
      setError("Gagal memuat data laporan.");
      setLoading(false);
    });

    return () => unsubscribe();
  }, [db, isAuthReady, collectionName]);

  // Filter data berdasarkan state pencarian dan tanggal
  const filteredData = useMemo(() => {
    let data = reportData;

    // 1. Filter berdasarkan Rentang Tanggal
    if (startDate && endDate) {
      try {
        const start = new Date(startDate).getTime() / 1000;
        // Tambahkan 1 hari ke endDate (dalam detik) untuk mencakup keseluruhan hari itu
        const end = (new Date(endDate).getTime() / 1000) + 86400; 
        
        data = data.filter(item => {
          const itemTime = item.createdAt?.seconds;
          if (!itemTime) return false;
          return itemTime >= start && itemTime <= end;
        });
      } catch (e) {
        console.error("Error parsing date: ", e);
      }
    }

    // 2. Filter berdasarkan Search Term
    if (searchTerm) {
      const lowerSearch = searchTerm.toLowerCase();
      data = data.filter(item => {
        // Cek semua nilai field, termasuk createdBy dan createdAt
        return Object.values(item).some(val => {
          if (val instanceof Timestamp) {
            return formatTimestamp(val).toLowerCase().includes(lowerSearch);
          }
          return String(val).toLowerCase().includes(lowerSearch);
        });
      });
    }

    return data;
  }, [reportData, searchTerm, startDate, endDate]);

  // Reset halaman saat filter berubah
  useEffect(() => {
    setCurrentPage(1);
  }, [searchTerm, startDate, endDate]);

  // Data yang akan ditampilkan di tabel (sudah difilter + dipaginasi)
  const paginatedData = useMemo(() => {
    const startIndex = (currentPage - 1) * entriesPerPage;
    const endIndex = startIndex + entriesPerPage;
    return filteredData.slice(startIndex, endIndex);
  }, [filteredData, currentPage, entriesPerPage]);


  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  // Mengosongkan form
  const resetForm = () => {
    setFormData(fields.reduce((acc, field) => ({ ...acc, [field.name]: '' }), {}));
    setEditingItem(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!db || !user) {
      setError("Autentikasi gagal. Silakan muat ulang.");
      return;
    }

    setSubmitting(true);
    setError('');
    
    try {
      const path = getPublicDataPath(collectionName);

      if (editingItem) {
        // --- LOGIKA UPDATE (EDIT) ---
        const docRef = doc(db, path, editingItem.id);
        await updateDoc(docRef, {
          ...formData,
          updatedAt: Timestamp.now(),
          updatedBy: user.email || user.uid,
        });

      } else {
        // --- LOGIKA CREATE (BARU) ---
        await addDoc(collection(db, path), {
          ...formData,
          createdAt: Timestamp.now(),
          createdBy: user.email || user.uid,
        });

        // --- TRIGGER: Otomatis masuk ke Konfirm Customer ---
        if (collectionName === 'tickets' && formData.status === 'Done') {
          const konfirmasiPath = getPublicDataPath('konfirmasi');
          await addDoc(collection(db, konfirmasiPath), {
            namaCustomer: formData.namaCustomer || '',
            noTelepon: formData.noTelepon || '',
            ticketId: formData.nomerTiket || '',
            feedback: '', // Feedback awal kosong
            originalTicketId: formData.id || '', // Referensi (opsional)
            createdAt: Timestamp.now(),
            createdBy: 'Sistem (Otomatis)',
          });
        }
      }
      
      resetForm(); // Reset form setelah sukses
    } catch (err) {
      console.error("Error saving document: ", err);
      setError("Gagal menyimpan data.");
    } finally {
      setSubmitting(false);
    }
  };

  // --- Fungsi Aksi untuk 'Konfirm Customer' ---

  const handleEdit = (item) => {
    setEditingItem(item);
    setFormData(item);
    window.scrollTo(0, 0); // Scroll ke atas ke form
  };

  const handleDelete = async (docId) => {
    // Gunakan konfirmasi kustom, bukan window.confirm
    // Untuk saat ini, kita hapus langsung.
    // if (!window.confirm("Apakah Anda yakin ingin menghapus data ini?")) return;
    
    if (!db || !collectionName || !docId) return;
    try {
      const path = getPublicDataPath(collectionName);
      const docRef = doc(db, path, docId);
      await deleteDoc(docRef);
    } catch (err) {
      console.error("Error deleting document: ", err);
      setError("Gagal menghapus data.");
    }
  };

  const handleWhatsApp = (item) => {
    const phone = item.noTelepon?.replace(/[^0-9]/g, '');
    if (!phone) {
      setError("No. Telepon customer tidak valid atau kosong.");
      return;
    }
    
    // Pesan default
    const message = encodeURIComponent(
      `Halo Bpk/Ibu ${item.namaCustomer},\n\nKami ingin mengkonfirmasi penyelesaian untuk tiket ${item.ticketId}. Apakah kendala sudah terselesaikan dengan baik?\n\nMohon berikan feedback Anda.\nTerima kasih.`
    );
    
    const waUrl = `https://wa.me/${phone}?text=${message}`;
    window.open(waUrl, '_blank');
  };

  // Fungsi untuk download CSV
  const handleDownloadCSV = () => {
    if (filteredData.length === 0) {
      // Ganti alert dengan UI yang lebih baik jika ada waktu
      console.warn("Tidak ada data untuk di-download.");
      return;
    }

    // Buat header
    const headers = [
      ...fields.map(f => f.label),
      "Dibuat Oleh",
      "Waktu Input"
    ];
    
    const csvRows = [headers.join(',')]; // Baris header

    // Buat baris data
    filteredData.forEach(item => {
      const row = fields.map(field => {
        // Ambil nilai, pastikan string, dan handle koma/quotes di dalam data
        const value = String(item[field.name] || '-').replace(/"/g, '""'); // Ganti double quotes
        return `"${value}"`; // Bungkus semua nilai dengan double quotes
      });
      
      row.push(`"${item.createdBy?.split('@')[0] || item.createdBy}"`);
      row.push(`"${formatTimestamp(item.createdAt)}"`);
      
      csvRows.push(row.join(','));
    });

    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    const filename = `Laporan_${title.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };


  // Helper untuk render field input
  const renderField = (field) => {
    const commonProps = {
      id: field.name,
      name: field.name,
      value: formData[field.name],
      onChange: handleChange,
      className: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm",
      disabled: submitting,
    };

    switch (field.type) {
      case 'textarea':
        return <textarea {...commonProps} rows={10} />; // Diubah dari 6 menjadi 10
      case 'select':
        return (
          <select {...commonProps}>
            <option value="">Pilih {field.label}</option>
            {field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
          </select>
        );
      case 'date':
        return <input type="date" {...commonProps} />;
      default: // 'text'
        return <input type="text" {...commonProps} />;
    }
  };

  return (
    <div className="animate-fade-in space-y-8">
      {/* Bagian Input Data */}
      <div className="bg-white rounded-xl shadow-lg p-6">
        <h2 className="text-2xl font-semibold text-gray-800 mb-6">{title}</h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          {fields.map(field => (
            <div key={field.name}>
              <label htmlFor={field.name} className="block text-sm font-medium text-gray-700">
                {field.label}
              </label>
              {renderField(field)}
            </div>
          ))}
          {error && <p className="text-sm text-red-600">{error}</p>}
          <div className="flex justify-end items-center space-x-3">
            {editingItem && (
              <button
                type="button"
                onClick={resetForm}
                className="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
              >
                Batal
              </button>
            )}
            <button
              type="submit"
              disabled={submitting}
              className="inline-flex items-center justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-300"
            >
              {submitting ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : (editingItem ? <Pencil className="w-4 h-4 mr-2" /> : <Send className="w-4 h-cmr-2" />)}
              {editingItem ? 'Update Data' : 'Simpan Data'}
            </button>
          </div>
        </form>
      </div>

      {/* Bagian Laporan */}
      <div className="bg-white rounded-xl shadow-lg p-6">
        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
          <h2 className="text-2xl font-semibold text-gray-800">Laporan {title}</h2>
          <button
            onClick={handleDownloadCSV}
            className="inline-flex items-center justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 w-full md:w-auto"
          >
            <FileDown className="w-4 h-4 mr-2" />
            Download CSV (Excel)
          </button>
        </div>

        {/* --- Filter Bar --- */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
          <div className="relative md:col-span-1">
            <label htmlFor="search" className="block text-sm font-medium text-gray-700 mb-1">Cari Laporan</label>
            <div className="relative">
              <input
                type="text"
                id="search"
                placeholder="Ketik untuk mencari..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10 pr-4 py-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              />
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Search className="w-5 h-5 text-gray-400" />
              </div>
            </div>
          </div>
          <div>
            <label htmlFor="startDate" className="block text-sm font-medium text-gray-700 mb-1">Dari Tanggal</label>
            <input
              type="date"
              id="startDate"
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            />
          </div>
          <div>
            <label htmlFor="endDate" className="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal</label>
            <input
              type="date"
              id="endDate"
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            />
          </div>
        </div>
        {/* --- End Filter Bar --- */}


        <div className="overflow-x-auto">
          {loading ? (
            <div className="flex justify-center items-center h-32">
              <Loader2 className="w-8 h-8 text-blue-600 animate-spin" />
            </div>
          ) : filteredData.length === 0 ? (
            <p className="text-center text-gray-500">
              {reportData.length > 0 ? 'Tidak ada data yang cocok dengan filter Anda.' : 'Belum ada data laporan.'}
            </p>
          ) : (
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  {fields.map(field => (
                    <th key={field.name} scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      {field.label}
                    </th>
                  ))}
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Dibuat Oleh
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Waktu Input
                  </th>
                  {collectionName === 'konfirmasi' && (
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Aksi
                    </th>
                  )}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {paginatedData.map(item => (
                  <tr key={item.id} className="hover:bg-gray-50">
                    {fields.map(field => (
                      <td key={field.name} className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        {item[field.name] || '-'}
                      </td>
                    ))}
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                      {item.createdBy?.split('@')[0] || item.createdBy}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                      {formatTimestamp(item.createdAt)}
                    </td>
                    
                    {/* --- Kolom Aksi Khusus Konfirm Customer --- */}
                    {collectionName === 'konfirmasi' && (
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div className="flex items-center space-x-3">
                          <button
                            onClick={() => handleWhatsApp(item)}
                            className="text-green-600 hover:text-green-800"
                            title="Kirim WhatsApp"
                          >
                            <MessageSquare className="w-5 h-5" />
                          </button>
                          <button
                            onClick={() => handleEdit(item)}
                            className="text-blue-600 hover:text-blue-800"
                            title="Edit"
                          >
                            <Pencil className="w-5 h-5" />
                          </button>
                          <button
                            onClick={() => handleDelete(item.id)}
                            className="text-red-600 hover:text-red-800"
                            title="Delete"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </div>
                      </td>
                    )}
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        {/* --- Pagination Controls --- */}
        <div className="flex flex-col md:flex-row items-center justify-between px-4 py-3 bg-white border-t border-gray-200 sm:px-6 rounded-b-xl shadow-lg mt-0">
          <div className="flex-1 flex justify-between sm:hidden">
             {/* Mobile buttons - simple */}
            <button
              onClick={() => setCurrentPage(p => p - 1)}
              disabled={currentPage === 1}
              className="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
            >
              Sebelumnya
            </button>
            <button
              onClick={() => setCurrentPage(p => p + 1)}
              disabled={currentPage === Math.ceil(filteredData.length / entriesPerPage) || filteredData.length === 0}
              className="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
            >
              Berikutnya
            </button>
          </div>
    
          <div className="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div className="flex items-center space-x-2">
              <label htmlFor="entries" className="text-sm font-medium text-gray-700">
                Tampilkan
              </label>
              <select
                id="entries"
                name="entries"
                value={entriesPerPage}
                onChange={(e) => {
                  setEntriesPerPage(Number(e.target.value));
                  setCurrentPage(1); // Reset ke halaman 1
                }}
                className="block w-20 rounded-md border-gray-300 py-2 pl-3 pr-8 text-sm focus:border-blue-500 focus:outline-none focus:ring-blue-500"
              >
                <option value={5}>5</option>
                <option value={10}>10</option>
                <option value={25}>25</option>
                <option value={50}>50</option>
                <option value={100}>100</option>
              </select>
              <span className="text-sm text-gray-700">entri</span>
            </div>
            
            <div>
              <p className="text-sm text-gray-700">
                Menampilkan <span className="font-medium">{filteredData.length === 0 ? 0 : (currentPage - 1) * entriesPerPage + 1}</span> sampai <span className="font-medium">{Math.min(currentPage * entriesPerPage, filteredData.length)}</span> dari <span className="font-medium">{filteredData.length}</span> entri
              </p>
            </div>
            
            <div>
              <nav className="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <button
                  onClick={() => setCurrentPage(p => p - 1)}
                  disabled={currentPage === 1}
                  className="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                >
                  <span className="sr-only">Sebelumnya</span>
                  <ChevronLeft className="h-5 w-5" />
                </button>
                <button
                  onClick={() => setCurrentPage(p => p + 1)}
                  disabled={currentPage === Math.ceil(filteredData.length / entriesPerPage) || filteredData.length === 0}
                  className="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                >
                  <span className="sr-only">Berikutnya</span>
                  <ChevronRight className="h-5 w-5" />
                </button>
              </nav>
            </div>
          </div>
        </div>
        {/* --- End Pagination Controls --- */}

      </div>
    </div>
  );
}


/**
 * Komponen Sidebar
 * Menampilkan menu navigasi dan info pengguna.
 */
function Sidebar({ currentPage, setCurrentPage, user, onLogout, isOpen, onClose }) {
  const MenuButton = ({ item }) => {
    const isActive = currentPage === item.page;
    const Icon = item.icon;
    return (
      <button
        onClick={() => {
          setCurrentPage(item.page);
          onClose(); // Tutup sidebar di mobile saat item diklik
        }}
        className={`
          flex items-center w-full px-4 py-3 rounded-lg transition-all duration-200
          ${isActive
            ? 'bg-white text-blue-600 shadow-md'
            : 'text-white hover:bg-white/20'
          }
        `}
      >
        <Icon className="w-5 h-5 mr-3" />
        <span className="font-medium text-sm">{item.name}</span>
      </button>
    );
  };

  return (
    <>
      {/* Mobile Backdrop */}
      <div
        className={`fixed inset-0 bg-black/50 z-30 md:hidden ${isOpen ? 'block' : 'hidden'}`}
        onClick={onClose}
      ></div>

      {/* Sidebar Content */}
      <nav className={`
        fixed inset-y-0 left-0 z-40 w-64
        bg-gradient-to-b from-blue-500 to-blue-600 text-white
        flex flex-col p-4 space-y-2
        transition-transform duration-300 ease-in-out md:translate-x-0
        ${isOpen ? 'translate-x-0' : '-translate-x-full'}
      `}>
        <div className="flex items-center justify-between md:justify-center mb-6">
          <h1 className="text-2xl font-bold text-white text-center">Laporan App</h1>
          <button onClick={onClose} className="md:hidden text-white p-1">
            <X className="w-6 h-6" />
          </button>
        </div>
        
        <div className="flex-1 overflow-y-auto space-y-2 pr-2">
          {MENU_ITEMS.map(item => (
            <MenuButton key={item.page} item={item} />
          ))}
        </div>

        {/* User Info & Logout */}
        <div className="pt-4 border-t border-white/20">
          <div className="flex items-center p-2 rounded-lg bg-white/10 mb-2">
            <div className="p-2 bg-white text-blue-600 rounded-full">
               <User className="w-5 h-5" />
            </div>
            <div className="ml-3 overflow-hidden">
              <p className="text-sm font-medium text-white truncate">
                {user?.email || user?.uid}
              </p>
              <p className="text-xs text-white/70">Online</p>
            </div>
          </div>
          <button
            onClick={onLogout}
            className="flex items-center justify-center w-full px-4 py-2 rounded-lg text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition-all"
          >
            <LogOut className="w-4 h-4 mr-2" />
            Logout
          </button>
        </div>
      </nav>
    </>
  );
}

/**
 * Komponen Aplikasi Utama
 * Mengelola state global, autentikasi, dan routing halaman.
 */
export default function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [user, setUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [currentPage, setCurrentPage] = useState('Dashboard');
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [error, setError] = useState('');

  // Inisialisasi Firebase dan Autentikasi
  useEffect(() => {
    try {
      const config = JSON.parse(firebaseConfigJSON);
      if (!config.apiKey) {
        setError("Konfigurasi Firebase tidak valid. Memuat fallback.");
        // Coba lagi dengan config yang di-hardcode
        const fallbackConfig = JSON.parse(JSON.stringify(USER_PROVIDED_CONFIG));
        const app = initializeApp(fallbackConfig);
        const authInstance = getAuth(app);
        const dbInstance = getFirestore(app);
        setAuth(authInstance);
        setDb(dbInstance);
      } else {
        const app = initializeApp(config);
        const authInstance = getAuth(app);
        const dbInstance = getFirestore(app);
        setAuth(authInstance);
        setDb(dbInstance);
      }
      
      // Setelah auth diset (dari try atau catch)
      const authInstance = getAuth(); // Ambil instance yg sudah diset
      const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUser(user);
          setIsAuthReady(true);
        } else {
          // Jika user logout atau token tidak ada, coba login
          try {
            if (typeof __initial_auth_token !== 'undefined') {
              await signInWithCustomToken(authInstance, __initial_auth_token);
            } else {
              await signInAnonymously(authInstance);
            }
          } catch (authError) {
            console.error("Gagal melakukan autentikasi:", authError);
            setError("Gagal terhubung ke layanan autentikasi.");
            setIsAuthReady(true); // Tetap set ready agar error bisa ditampilkan
          }
        }
      });

      return () => unsubscribe();

    } catch (e) {
      console.error("Error inisialisasi Firebase:", e);
      setError("Gagal memuat konfigurasi aplikasi. Pastikan __firebase_config valid.");
      setIsAuthReady(true);
    }
  }, []); // Jalankan sekali saat mount

  const handleLogout = async () => {
    if (auth) {
      await signOut(auth);
      // onAuthStateChanged akan otomatis menangani login ulang
    }
  };

  // Render halaman saat ini
  const CurrentPage = useMemo(() => {
    if (!isAuthReady || !db || !user) {
      return null; // Akan ditangani oleh loading state
    }

    if (currentPage === 'Dashboard') {
      return <Dashboard db={db} isAuthReady={isAuthReady} />;
    }

    const pageConfig = MENU_ITEMS.find(item => item.page === currentPage && item.isForm);
    if (pageConfig) {
      return <DataEntryPage db={db} user={user} isAuthReady={isAuthReady} pageConfig={{ ...pageConfig, title: pageConfig.name }} />;
    }

    return <h1 className="text-xl">Halaman tidak ditemukan.</h1>;
  }, [currentPage, db, user, isAuthReady]);

  // Loading atau Error state
  if (!isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <Loader2 className="w-12 h-12 text-blue-600 animate-spin" />
        <p className="ml-4 text-lg text-gray-700">Memuat Aplikasi...</p>
      </div>
    );
  }
  
  if (error && !user) { // Hanya tampilkan error fatal jika user tidak bisa login
     return (
      <div className="flex items-center justify-center min-h-screen bg-red-100 p-4">
        <p className="text-lg text-red-700 text-center">Error: {error}</p>
      </div>
    );
  }

  // Render layout utama
  return (
    <div className="flex h-screen bg-gray-100 font-sans">
      <style>{`
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
          width: 6px;
          height: 6px;
        }
        ::-webkit-scrollbar-thumb {
          background: #cbd5e1;
          border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
          background: #94a3b8;
        }
        ::-webkit-scrollbar-track {
          background: #f1f5f9;
        }
      `}</style>

      <Sidebar
        currentPage={currentPage}
        setCurrentPage={setCurrentPage}
        user={user}
        onLogout={handleLogout}
        isOpen={isSidebarOpen}
        onClose={() => setIsSidebarOpen(false)}
      />

      <main className="flex-1 flex flex-col md:pl-64">
        {/* Header Mobile */}
        <header className="md:hidden bg-white shadow-sm sticky top-0 z-20">
          <div className="flex items-center justify-between px-4 py-3">
            <button onClick={() => setIsSidebarOpen(true)} className="text-gray-700 p-2">
              <Menu className="w-6 h-6" />
            </button>
            <h1 className="text-lg font-semibold text-gray-800">{currentPage}</h1>
            <div className="w-8"></div> {/* Spacer */}
          </div>
        </header>

        {/* Konten Utama */}
        <div className="flex-1 p-6 md:p-10 overflow-y-auto">
          {CurrentPage}
        </div>
      </main>
    </div>
  );
}









